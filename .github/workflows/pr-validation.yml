name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main
      - 'claude/**'

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'

jobs:
  # Basic validation
  validate:
    name: Validate PR
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Validate branch naming
        if: github.event_name == 'pull_request'
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          echo "Validating branch: $BRANCH_NAME"

          # Allow claude/ prefix for AI agents
          if [[ "$BRANCH_NAME" =~ ^claude/ ]]; then
            echo "✅ Valid agent branch"
          elif [[ "$BRANCH_NAME" =~ ^(feature|fix|docs|chore|refactor)/ ]]; then
            echo "✅ Valid feature branch"
          else
            echo "⚠️ Warning: Non-standard branch naming"
          fi

      - name: Check for required files
        run: |
          echo "Checking required files..."
          REQUIRED_FILES=(
            "README.md"
            "LICENSE"
          )
          for file in "${REQUIRED_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "✅ $file exists"
            else
              echo "❌ $file missing"
              exit 1
            fi
          done

  # Hash verification
  hash-verification:
    name: Hash Verification
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Generate file hashes
        run: |
          echo "Generating SHA-256 hashes for modified files..."

          # Create hash manifest
          mkdir -p .github/hashes

          find . -type f \
            -not -path "./.git/*" \
            -not -path "./node_modules/*" \
            -not -path "./__pycache__/*" \
            -not -name "*.pyc" \
            -exec sha256sum {} \; > .github/hashes/manifest.txt

          echo "Generated hashes for $(wc -l < .github/hashes/manifest.txt) files"

      - name: Verify hash integrity
        run: |
          if [ -f "kanban/hashing/sha256.py" ]; then
            echo "Running hash verification..."
            python3 kanban/hashing/sha256.py hash-dir . || true
          else
            echo "Hash utility not found, skipping verification"
          fi

      - name: Upload hash manifest
        uses: actions/upload-artifact@v4
        with:
          name: hash-manifest
          path: .github/hashes/manifest.txt
          retention-days: 30

  # Python linting and testing
  python-checks:
    name: Python Checks
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort

      - name: Check Python syntax
        run: |
          # Find Python files and check syntax
          find . -name "*.py" -not -path "./.git/*" | while read file; do
            python -m py_compile "$file" && echo "✅ $file" || echo "❌ $file"
          done

      - name: Run flake8 (non-blocking)
        continue-on-error: true
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || true

  # JavaScript linting
  js-checks:
    name: JavaScript Checks
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Check JavaScript syntax
        run: |
          # Find JS files and check syntax
          find . -name "*.js" -not -path "./.git/*" -not -path "./node_modules/*" | while read file; do
            node --check "$file" 2>/dev/null && echo "✅ $file" || echo "⚠️ $file (check failed)"
          done

  # Integration endpoint checks
  integration-checks:
    name: Integration Checks
    runs-on: ubuntu-latest
    needs: [validate, hash-verification]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate integration configs
        run: |
          echo "Validating integration configurations..."

          if [ -f "kanban/integrations/endpoints.json" ]; then
            echo "Checking endpoints.json..."
            python3 -c "import json; json.load(open('kanban/integrations/endpoints.json'))" && \
              echo "✅ endpoints.json is valid JSON" || \
              echo "❌ endpoints.json is invalid"
          fi

      - name: Check Cloudflare Worker syntax
        run: |
          if [ -f "kanban/integrations/cloudflare-worker.js" ]; then
            node --check kanban/integrations/cloudflare-worker.js && \
              echo "✅ Cloudflare Worker syntax valid" || \
              echo "❌ Cloudflare Worker syntax error"
          fi

  # Security scan
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for secrets
        run: |
          echo "Scanning for potential secrets..."

          # Check for common secret patterns (non-blocking)
          PATTERNS=(
            "password\s*="
            "api_key\s*="
            "secret\s*="
            "token\s*="
          )

          FOUND=0
          for pattern in "${PATTERNS[@]}"; do
            if grep -rniE "$pattern" --include="*.py" --include="*.js" --include="*.json" . 2>/dev/null | grep -v "EnvVar\|process.env\|\${"; then
              echo "⚠️ Potential secret pattern found: $pattern"
              FOUND=1
            fi
          done

          if [ $FOUND -eq 0 ]; then
            echo "✅ No obvious secrets found"
          fi

      - name: Check .env files
        run: |
          if find . -name ".env" -o -name ".env.*" | grep -v ".env.example"; then
            echo "❌ WARNING: .env files should not be committed!"
            exit 1
          else
            echo "✅ No .env files found"
          fi

  # Final status
  pr-status:
    name: PR Status
    runs-on: ubuntu-latest
    needs: [validate, hash-verification, python-checks, js-checks, integration-checks, security-scan]
    if: always()
    steps:
      - name: Check job results
        run: |
          echo "=================================="
          echo "       PR VALIDATION RESULTS"
          echo "=================================="
          echo ""
          echo "Validate: ${{ needs.validate.result }}"
          echo "Hash Verification: ${{ needs.hash-verification.result }}"
          echo "Python Checks: ${{ needs.python-checks.result }}"
          echo "JS Checks: ${{ needs.js-checks.result }}"
          echo "Integration Checks: ${{ needs.integration-checks.result }}"
          echo "Security Scan: ${{ needs.security-scan.result }}"
          echo ""

          # Fail if critical checks failed
          if [ "${{ needs.validate.result }}" == "failure" ] || \
             [ "${{ needs.security-scan.result }}" == "failure" ]; then
            echo "❌ Critical checks failed"
            exit 1
          fi

          echo "✅ All checks passed"
